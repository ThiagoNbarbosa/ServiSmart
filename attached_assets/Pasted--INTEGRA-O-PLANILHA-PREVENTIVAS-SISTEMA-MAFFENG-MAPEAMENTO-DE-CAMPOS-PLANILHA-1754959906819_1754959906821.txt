# üîó INTEGRA√á√ÉO PLANILHA PREVENTIVAS ‚Üí SISTEMA MAFFENG

## üìä MAPEAMENTO DE CAMPOS

### PLANILHA PREVENTIVAS ‚Üí WORK ORDERS
```
A1: ELABORADOR DE RELAT√ìRIO    ‚Üí report_creator_id (FK)
B1: DATA LEVANTAMENTO          ‚Üí survey_date
C1: CONTRATO                   ‚Üí contract_number
D1: OS                         ‚Üí work_order_number
E1: PREFIXO                    ‚Üí equipment_prefix
F1: AG√äNCIA                    ‚Üí agency_name
G1: VALOR PREVENTIVA OR√áAMENTO ‚Üí preventive_budget_value
H1: VENCIMENTO PORTAL          ‚Üí portal_deadline
I1: SITUA√á√ÉO                   ‚Üí situation_status
J1: T√âCNICO PREVENTIVA         ‚Üí preventive_technician_id (FK)
K1: DATA AGENDAMENTO           ‚Üí scheduled_date
L1: DIFICULDADES               ‚Üí difficulties_notes
M1: STATUS                     ‚Üí execution_status
```

## üóÑÔ∏è ESTRUTURA DE BANCO SUGERIDA

### Tabela: `preventive_maintenance_orders`
```sql
CREATE TABLE preventive_maintenance_orders (
    id SERIAL PRIMARY KEY,
    report_creator_id INT REFERENCES technicians(id),
    survey_date DATE,
    contract_number VARCHAR(50),
    work_order_number VARCHAR(50) UNIQUE,
    equipment_prefix VARCHAR(20),
    agency_name VARCHAR(100),
    preventive_budget_value DECIMAL(10,2),
    portal_deadline DATE,
    situation_status VARCHAR(50),
    preventive_technician_id INT REFERENCES technicians(id),
    scheduled_date DATE,
    scheduled_status VARCHAR(20) DEFAULT 'AGENDADO', -- 'AGENDADO' ou 'EXECUTANDO'
    difficulties_notes TEXT,
    execution_status VARCHAR(20),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### Enums Sugeridos
```sql
-- Status de Situa√ß√£o
CREATE TYPE situation_status_enum AS ENUM (
    'ENVIADA_ORCAMENTO',
    'FORNECEDOR_ACIONADO',
    'LEVANTAMENTO_OK',
    'ORCAMENTO_APROVADO_RETORNO_FORNECEDOR',
    'RETORNO_FORNECEDOR',
    'SERVICO_CONCLUIDO',
    'SERVICO_CONCLUIDO_PENDENTE_RELATORIO'
);

-- Status de Execu√ß√£o
CREATE TYPE execution_status_enum AS ENUM (
    'ABERTA',
    'CONCLUIDA',
    'PARCIAL'
);

-- Status de Agendamento
CREATE TYPE scheduling_status_enum AS ENUM (
    'AGENDADO',
    'EXECUTANDO'
);
```

## üîß IMPLEMENTA√á√ÉO NO FRONTEND

### 1. Atualizar P√°gina Work Orders
**Arquivo**: `client/src/pages/work-orders.tsx`

```typescript
// Adicionar ao formato de importa√ß√£o existente
const PREVENTIVAS_IMPORT_FORMAT = {
  A: "ELABORADOR DE RELAT√ìRIO",
  B: "DATA LEVANTAMENTO", 
  C: "CONTRATO",
  D: "OS",
  E: "PREFIXO",
  F: "AG√äNCIA",
  G: "VALOR PREVENTIVA OR√áAMENTO",
  H: "VENCIMENTO PORTAL",
  I: "SITUA√á√ÉO",
  J: "T√âCNICO PREVENTIVA",
  K: "DATA AGENDAMENTO", 
  L: "DIFICULDADES",
  M: "STATUS"
};
```

### 2. Novo Componente: Preventivas Import Modal
**Arquivo**: `client/src/components/PreventivasImportModal.tsx`

```typescript
interface PreventivasImportModalProps {
  isOpen: boolean;
  onClose: () => void;
  onImport: (data: PreventivasData[]) => void;
}

const PreventivasImportModal = ({ isOpen, onClose, onImport }: PreventivasImportModalProps) => {
  // L√≥gica espec√≠fica para importa√ß√£o de Preventivas
  // Valida√ß√£o dos campos obrigat√≥rios
  // Preview dos dados antes da importa√ß√£o
};
```

### 3. Valida√ß√£o com Zod
```typescript
const PreventivasImportSchema = z.object({
  reportCreator: z.string().min(1, "Elaborador de relat√≥rio obrigat√≥rio"),
  surveyDate: z.date(),
  contractNumber: z.string().optional(),
  workOrderNumber: z.string().min(1, "N√∫mero da OS obrigat√≥rio"),
  equipmentPrefix: z.string().optional(),
  agencyName: z.string().min(1, "Nome da ag√™ncia obrigat√≥rio"),
  preventiveBudgetValue: z.number().positive("Valor deve ser positivo"),
  portalDeadline: z.date(),
  situationStatus: z.enum([
    "ENVIADA_ORCAMENTO",
    "FORNECEDOR_ACIONADO", 
    "LEVANTAMENTO_OK",
    "ORCAMENTO_APROVADO_RETORNO_FORNECEDOR",
    "RETORNO_FORNECEDOR",
    "SERVICO_CONCLUIDO",
    "SERVICO_CONCLUIDO_PENDENTE_RELATORIO"
  ]),
  preventiveTechnician: z.string().optional(),
  scheduledDate: z.date().optional(),
  scheduledStatus: z.enum(["AGENDADO", "EXECUTANDO"]).optional(),
  difficultiesNotes: z.string().optional(),
  executionStatus: z.enum(["ABERTA", "CONCLUIDA", "PARCIAL"])
});
```

## üöÄ IMPLEMENTA√á√ÉO NO BACKEND

### 1. Nova Rota de Importa√ß√£o RAT
**Arquivo**: `server/routes/work-orders.ts`

```typescript
// POST /api/work-orders/import-rat
router.post('/import-rat', upload.single('file'), async (req, res) => {
  try {
    const workbook = XLSX.read(req.file.buffer);
    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
    const rawData = XLSX.utils.sheet_to_json(worksheet);
    
    // Mapear dados da planilha para formato do sistema
    const mappedData = rawData.map(row => mapRATData(row));
    
    // Validar dados
    const validatedData = mappedData.map(data => 
      RATImportSchema.parse(data)
    );
    
    // Inserir no banco
    const result = await db.insert(workOrdersRAT).values(validatedData);
    
    res.json({ success: true, imported: result.length });
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});
```

### 2. Fun√ß√£o de Mapeamento
```typescript
const mapRATData = (row: any) => ({
  reportCreator: row['ELABORADOR DE RELAT√ìRIO'],
  surveyDate: parseDate(row['DATA LEVANTAMENTO']),
  contractNumber: row['CONTRATO'],
  workOrderNumber: row['OS'],
  equipmentPrefix: row['PREFIXO'],
  agencyName: row['AG√äNCIA'],
  ratBudgetValue: parseFloat(row['VALOR RAT OR√áAMENTO']),
  portalDeadline: parseDate(row['VENCIMENTO PORTAL']),
  situationStatus: normalizeSituationStatus(row['SITUA√á√ÉO']),
  preventiveTechnician: row['T√âCNICO PREVENTIVA'],
  scheduledDate: parseScheduledDate(row['DATA AGENDAMENTO']),
  scheduledStatus: determineScheduledStatus(row['DATA AGENDAMENTO']),
  difficultiesNotes: row['DIFICULDADES'],
  executionStatus: row['STATUS']
});

// Fun√ß√£o auxiliar para determinar status de agendamento
const determineScheduledStatus = (agendamento: string) => {
  if (agendamento === 'EXECUTANDO') return 'EXECUTANDO';
  if (isValidDate(agendamento)) return 'AGENDADO';
  return null;
};

// Fun√ß√£o para normalizar status de situa√ß√£o
const normalizeSituationStatus = (situacao: string) => {
  const statusMap = {
    'Enviada para Or√ßamento': 'ENVIADA_ORCAMENTO',
    'Fornecedor Acionado': 'FORNECEDOR_ACIONADO',
    'Levantamento OK': 'LEVANTAMENTO_OK',
    'Or√ßamento Aprovado - Retorno ao Fornecedor': 'ORCAMENTO_APROVADO_RETORNO_FORNECEDOR',
    'Retorno ao Fornecedor': 'RETORNO_FORNECEDOR',
    'Servi√ßo Conclu√≠do': 'SERVICO_CONCLUIDO',
    'Servi√ßo Conclu√≠do - Pendente Relat√≥rio': 'SERVICO_CONCLUIDO_PENDENTE_RELATORIO'
  };
  
  return statusMap[situacao] || situacao;
};
```

## üìä NOVA P√ÅGINA: RAT MANAGEMENT

### Estrutura da P√°gina
```
/rat-management
‚îú‚îÄ‚îÄ Header com estat√≠sticas
‚îú‚îÄ‚îÄ Filtros (por ag√™ncia, status, t√©cnico)
‚îú‚îÄ‚îÄ Tabela com dados RAT
‚îú‚îÄ‚îÄ Modal de detalhes
‚îî‚îÄ‚îÄ A√ß√µes em lote
```

### Funcionalidades
- ‚úÖ Importa√ß√£o de planilhas RAT
- ‚úÖ Visualiza√ß√£o em tabela
- ‚úÖ Filtros avan√ßados
- ‚úÖ Exporta√ß√£o de relat√≥rios
- ‚úÖ Acompanhamento de prazos
- ‚úÖ Notifica√ß√µes de vencimento
- ‚úÖ Dashboard espec√≠fico RAT

## üéØ PR√ìXIMOS PASSOS

### Fase 1: Core Implementation
1. Criar estrutura de banco
2. Implementar importa√ß√£o RAT
3. Criar p√°gina RAT Management
4. Testes de importa√ß√£o

### Fase 2: Features Avan√ßadas
1. Dashboard RAT espec√≠fico
2. Notifica√ß√µes autom√°ticas
3. Relat√≥rios avan√ßados
4. Integra√ß√£o com sistema existente

### Fase 3: Otimiza√ß√µes
1. Valida√ß√µes em tempo real
2. Preview de importa√ß√£o
3. Hist√≥rico de altera√ß√µes
4. APIs para integra√ß√£o externa

## üîç CONSIDERA√á√ïES T√âCNICAS

### Performance
- Importa√ß√£o em lotes para arquivos grandes
- Indexa√ß√£o em campos de busca frequente
- Cache de consultas complexas

### Seguran√ßa
- Valida√ß√£o rigorosa de dados
- Sanitiza√ß√£o de inputs
- Logs de auditoria

### UX/UI
- Feedback visual durante importa√ß√£o
- Estados de loading apropriados
- Mensagens de erro claras
- Preview antes da importa√ß√£o final